{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "org.trychlos.TheToolsProject/schemas/meteor_deploy.schema.json",
    "title": "Meteor::Deploy",
    "description_array": [
        "The 'meteor.pl deploy' verb relies on:",
        "- a Meteor application project directory to be able to build an application bundle,",
        "- which contains a JSON deployments definition which describes how to and where deploy this bundle.",
        "In other words, this verb requires to adress a local development environment to be able to run, even if this local development environment is not a source nor a target of the deployment.",
        "The name of the application is those read from the addressed local environment's package.json. It itself defaults to the basename of the application directory."
    ],
    "type": "object",
    "properties": {
        "targets": {
            "description": "The definitions of deployment targets and their properties.",
            "type": "object",
            "patternProperties": {
                "^.*$": {
                    "description": "The target environment identifier.",
                    "type": "object",
                    "properties": {
                        "additional_env": {
                            "description_array": [
                                "The list of name and value of application additional environment variables.",
                                "The application environment is at least set with the variables:",
                                "- APP_ENV: the environment identifier,",
                                "- ROOT_URL: mandatory when running nodejs.",
                                "The additional list may also contain MAIL_URL, MONGO_URL, NODE_ENV, PORT.",
                                "Note: when embedding username/passwords, we could take advantage of using the Chrome console, and the 'encodeURIComponent(str)' function..."
                            ],
                            "type": "object",
                            "patternProperties": {
                                "^.*$": {
                                    "description": "The name of the environment variable, the value being the value of this environment variable.",
                                    "type": "string"
                                }
                            }
                        },
                        "allowed_sources": {
                            "description_array": [
                                "The identifiers of the environments which can be a source when deploying to this one.",
                                "Default is to allow all environments as potential sources."
                            ],
                            "type": "array",
                            "items": {
                                "type": "string"
                            }
                        },
                        "allowed_targets": {
                            "description_array": [
                                "The identifiers of the environments which can be a target when deploying from this one.",
                                "Default is to allow all environments as potential targets."
                            ],
                            "type": "array",
                            "items": {
                                "type": "string"
                            }
                        },
                        "forbidden_sources": {
                            "description_array": [
                                "The identifiers of the environments which cannot be a source when deploying to this one.",
                                "Default is to not forbid any source environment."
                            ],
                            "type": "array",
                            "items": {
                                "type": "string"
                            }
                        },
                        "forbidden_targets": {
                            "description_array": [
                                "The identifiers of the environments which cannot be a target when deploying from this one.",
                                "Default is to not forbid any target environment."
                            ],
                            "type": "array",
                            "items": {
                                "type": "string"
                            }
                        },
                        "git_branches": {
                            "description_array": [
                                "The list of allowed git branches to be deployed from.",
                                "This is only checked if the source directory of the deployment is a git repository."
                            ],
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "default": [ "master" ]
                        },
                        "host": {
                            "description_array": [
                                "The name or IP address of the machine which hosts this environment.",
                                "This host must be configured for ssh access from source environments.",
                                "This property is mandatory for all remote environments."
                            ],
                            "type": "string"
                        },
                        "isAllowedSource": {
                            "description": "Whether this environment can be the source of a deployment.",
                            "type": "boolean",
                            "default": true
                        },
                        "isAllowedTarget": {
                            "description": "Whether this environment can be the target of a deployment.",
                            "type": "boolean",
                            "default": true
                        },
                        "label_env": {
                            "description_array": [
                                "A label for the environment.",
                                "Displayed by 'meteor.pl deploy --list'."
                            ],
                            "type": "string"
                        },
                        "mongo_db": {
                            "description": "The name of the MongoDB database which contains the web site data.",
                            "type": "string"
                        },
                        "mongo_ip": {
                            "description": "The IP address the MongoDB server is listening to.",
                            "type": "string"
                        },
                        "mongo_port": {
                            "description": "The port number the MongoDB server is listening to.",
                            "type": "integer"
                        },
                        "path": {
                            "description_array": [
                                "The target path of the deployment, and the home directory of the user account.",
                                "This property is mandatory for all remote environments."
                            ],
                            "type": "string"
                        },
                        "root_url": {
                            "description_array": [
                                "The canonical URL of this web site.",
                                "This is needed when building the bundle, and default to 'https://host'."
                            ],
                            "type": "string"
                        },
                        "script_name": {
                            "description_array": [
                                "The name of the script which runs the service, defaulting to the application name.",
                                "Because it is located in the home directory of the user account, we do not expect any collision risk."
                            ],
                            "type": "string"
                        },
                        "service_name": {
                            "description_array": [
                                "The name of the target Systemd service, defaulting to the application name.",
                                "Be cautious of possible collisions when several environment are defined to live in the same host."
                            ],
                            "type": "string"
                        },
                        "user_account": {
                            "description_array": [
                                "The user account which owns the target service, defaulting to the application name.",
                                "Be cautious of possible collisions when several environment are defined to live in the same host."
                            ],
                            "type": "string"
                        },
                        "user_group": {
                            "description_array": [
                                "The user group which owns the target service, defaulting to the application name.",
                                "Be cautious of possible collisions when several environment are defined to live in the same host."
                            ],
                            "type": "string"
                        }
                    }
                }
            }
        },
        "versioning": {
            "description_array": [
                "Describes where to find and update the version number of the site.",
                "The files specified as updated with the deployed version when building the bundle, and default to be committed in the git repository."
            ],
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "filename": {
                        "description": "The filename, from the root project directory, to a JSON version file.",
                        "type": "string"
                    },
                    "pattern": {
                        "description": "A regular expression pattern to catch the version.",
                        "type": "string"
                    },
                    "replacement": {
                        "description": "A regular expression replacement member to update the version. Can use the '<VERSION> macro.",
                        "type": "string"
                    }
                }
            }
        }
    }
}
