{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "org.trychlos.TheToolsProject/schemas/http_compare.schema.json",
    "title": "Site",
    "description_array": [
        "The 'http.pl compare' verb relies on:",
        "- a JSON configuration file addressed by the '--json' command-line option,",
        "- a chromedriver server to talk to the Selenium::Remote::Driver package; runs it with '~/data/chromedriver-linux64/chromedriver --port=9515'.",
        "NB:",
        "1. The chromedriver version MUST match the currently running Chromium version.",
        "2. The verb runs an external daemon for each one of 'ref' and 'new' sites, and so must be configured accordingly."
    ],
    "type": "object",
    "properties": {
        "bases": {
            "description": "The base URLs to be compared.",
            "type": "object",
            "properties": {
                "new": {
                    "description": "The (mandatory) base URL to be compared against the above reference.",
                    "type": "object",
                    "properties": {
                        "url": {
                            "description": "The (mandatory) new base URL to be compared against the 'ref.url' reference.",
                            "type": "string"
                        },
                        "port": {
                            "description": "The listening port number of 'new' site child process, defaulting to the 'ref' child process listening port plus 1.",
                            "type": "integer"
                        }
                    }
                },
                "ref": {
                    "description": "The reference site characteristics.",
                    "type": "object",
                    "properties": {
                        "url": {
                            "description": "The (mandatory) reference base URL.",
                            "type": "string"
                        },
                        "port": {
                            "description": "The listening port number of 'ref' site child process, defaulting to the chromedriver listening port plus 1.",
                            "type": "integer"
                        }
                    }
                },
                "worker": {
                    "description": "The full path to the executable daemon.",
                    "type": "string",
                    "default": "TOOLS/libexec/daemons/http-compare-daemon.pl"
                }
            }
        },
        "browser": {
            "description": "The window-less internal browser properties.",
            "type": "object",
            "properties": {
                "command": {
                    "description": "The command to run the chromedriver.",
                    "type": "string",
                    "default": "chromedriver --port=9515 --url-base=/wd/hub --verbose"
                },
                "delays": {
                    "description_array": [
                        "The various delays, exprimed as seconds with possibly a fractional value, while we are waiting for something to happen.",
                        "These are NOT timeouts: the configured delay is always totally consumed as the waited thing is considered done only after this delay."
                    ],
                    "type": "object",
                    "properties": {
                        "wait_for_dom_stable": {
                            "description": "How much time the text length and count of elements must leave unchanged for the DOM be considered as stable.",
                            "type": "number",
                            "default": 1.0
                        },
                        "wait_for_network_idle": {
                            "description": "How much time the network must be idle for the page be considered as having terminated its load.",
                            "type": "number",
                            "default": 1.0
                        }
                    }
                },
                "driver_port": {
                    "description": "The port the chromedriver is listening to.",
                    "type": "integer",
                    "default": 9515
                },
                "driver_server": {
                    "description": "The chromedriver server address.",
                    "type": "string",
                    "default": "127.0.0.1"
                },
                "exec_js": {
                    "description": "Handle the javascript executions on the sites.",
                    "type": "object",
                    "properties": {
                        "retries": {
                            "description": "The count of retries when the javascript execution times out.",
                            "type": "integer",
                            "default": 5
                        },
                        "sleep": {
                            "description": "How many seconds wait between two timed-out javascript executions.",
                            "type": "integer",
                            "default": 5
                        }
                    }
                },
                "height": {
                    "description": "The height in pixels of the internal browser window.",
                    "type": "integer",
                    "default": 768
                },
                "navigate": {
                    "description": "Handle the navigation on the sites.",
                    "type": "object",
                    "properties": {
                        "retries": {
                            "description": "The count of retries when the navigation times out.",
                            "type": "integer",
                            "default": 5
                        },
                        "sleep": {
                            "description": "How many seconds wait between two timed-out navigations.",
                            "type": "integer",
                            "default": 5
                        }
                    }
                },
                "timeout": {
                    "description": "The timeout in seconds of interactions with internal browser.",
                    "type": "integer",
                    "default": 5
                },
                "timeouts": {
                    "description": "The various timeouts, exprimed as seconds with possibly a fractional value, defined when interacting with the internal browser.",
                    "type": "object",
                    "properties": {
                        "execute": {
                            "description": "The timeout when executing a command simultaneously on the two daemons.",
                            "type": "number",
                            "default": 10.0
                        },
                        "generic_waiter": {
                            "description": "The generic waiter timeout.",
                            "type": "number",
                            "default": 10.0
                        },
                        "get_answer": {
                            "description": "The timeout when waiting for an answer from the daemon.",
                            "type": "number",
                            "default": 10.0
                        },
                        "http": {
                            "description_array": [
                                "When about to send a HTTP request to the browser, the timeout before returning a 599 status code.",
                                "Would default to 60 sec. according to https://perldoc.perl.org/HTTP::Tiny#new, set to 10 sec. here."
                            ],
                            "type": "integer",
                            "default": 10
                        },
                        "send_command": {
                            "description": "When about to send a command to the daemon, the timeout to create the client socket.",
                            "type": "number",
                            "default": 10.0
                        },
                        "ua": {
                            "description": "The Selenium::Remote::Driver underlying LWP user agent timeout in seconds.",
                            "type": "integer",
                            "default": 10
                        },
                        "wait_for_body": {
                            "description": "After having navigated to an URL or clicked on a xpath, the timeout while waiting for the 'body' tag.",
                            "type": "number",
                            "default": 10.0
                        },
                        "wait_for_dom_stable": {
                            "description": "After having navigated to an URL or clicked on a xpath, the timeout while waiting for the DOM be stable.",
                            "type": "number",
                            "default": 10.0
                        },
                        "wait_for_network_idle": {
                            "description": "After having navigated to an URL or clicked on a xpath, the timeout while waiting for the network be idle.",
                            "type": "number",
                            "default": 10.0
                        },
                        "wait_for_page_ready": {
                            "description": "After having navigated to an URL or clicked on a xpath, the timeout while waiting for the page be globally ready.",
                            "type": "number",
                            "default": 15.0
                        },
                        "wait_for_url_change": {
                            "description": "After having navigated to an URL , the timeout while waiting for the URL to change.",
                            "type": "number",
                            "default": 10.0
                        }
                    }
                },
                "width": {
                    "description": "The width in pixels of the internal browser window.",
                    "type": "integer",
                    "default": 1366
                },
                "workdir": {
                    "description": "Let the created browsers define their user-data-dir inside of 'workdir'. Must be inside of a POSIX filesystem.",
                    "type": "string",
                    "default": "A derivative of the user .cache/ directory."
                }
            }
        },
        "compare": {
            "description_array": [
                "The full description of how to compare the two sites, and how provide the comparison results.",
                "We can compare rendered HTMLs as well as screenshots of the rendered pages.",
                "When comparison is enabled, we can just count (the minimum), and/or keep the objects too, and/or isolate them in a separate directory."
            ],
            "type": "object",
            "properties": {
                "htmls": {
                    "description": "Whether and how to compare rendered HTMLs.",
                    "type": "object",
                    "properties": {
                        "enabled": {
                            "description": "Whether the HTMLs comparison is enabled.",
                            "type": "boolean",
                            "default": false
                        },
                        "ignore": {
                            "description": "A list of patterns to be ignored when comparing.",
                            "type": "object",
                            "properties": {
                                "dom_attributes": {
                                    "description": "The list of regexes of DOM attributes to be ignored.",
                                    "type": "array",
                                    "items": {
                                        "type": "string"
                                    },
                                    "default": [
                                        "^aria-"
                                    ]
                                },
                                "dom_selectors": {
                                    "description": "The list of regexes of DOM selectors to be ignored.",
                                    "type": "array",
                                    "items": {
                                        "type": "string"
                                    },
                                    "default": [
                                        "script",
                                        "style"
                                    ]
                                },
                                "text_patterns": {
                                    "description": "The list of regexes of text patterns to be ignored.",
                                    "type": "array",
                                    "items": {
                                        "type": "string"
                                    },
                                    "default": [
                                    ]
                                }
                            }
                        }
                    }
                },
                "screenshots": {
                    "description": "Whether and how to compare screenshots of rendered pages.",
                    "type": "object",
                    "properties": {
                        "enabled": {
                            "description": "Whether the screenshots comparison is enabled.",
                            "type": "string",
                            "enum": [ "never", "onerror", "always" ],
                            "default": "onerror"
                        },
                        "rmse_threshold": {
                            "description": "Accepted pixel error rate (defaulting to 1 %).",
                            "type": "number",
                            "multipleOf" : 0.01,
                            "default": 0.01
                        },
                        "threshold_count": {
                            "description": "The count of accepted differences, computed with an avg square method.",
                            "type": "integer",
                            "default": 150
                        }
                    }
                }
            }
        },
        "crawl": {
            "description": "The full configuration of the iterative/recursive searches.",
            "type": "object",
            "properties": {
                "by_click": {
                    "description": "The description of a crawling operations by clicking anywhere.",
                    "type": "object",
                    "properties": {
                        "css_excludes": {
                            "description": "The list of CSS selectors to exclude. Empty means none. Patterns are applied against the CSS selector of the clickable.",
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "default": [
                                "th > a"
                            ]
                        },
                        "enabled": {
                            "description": "Whether we want crawl by clicking anywhere. Overridable in the command-line.",
                            "type": "boolean",
                            "default": false
                        },
                        "finders": {
                            "description": "How to find the clickables in this website.",
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "default": [
                                "a[href]",
                                "[role=\"link\"]",
                                "[data-link]",
                                "[data-router-link]",
                                "button",
                                "[onclick]"
                            ]
                        },
                        "href_deny_paterns": {
                            "description": "The list of href patterns to exclude. Empty means none. Patterns are applied against the 'href' attribute of the clickable.",
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "default": [
                                "^#.+",
                                "^callto:",
                                "^mailto:",
                                "^tel:"
                            ]
                        },
                        "intermediate_screenshots": {
                            "description": "Whether to save intermediate screenshots when restoring a chain. Mostly useful while debugging the verb.",
                            "type": "boolean",
                            "default": false
                        },
                        "successive_last": {
                            "description": "Count of successive same errors which cancel the role comparison.",
                            "type": "integer",
                            "default": 10
                        },
                        "text_deny_paterns": {
                            "description": "The list of text patterns to exclude. Empty means none.",
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "default": [
                            ]
                        },
                        "xpath_deny_paterns": {
                            "description": "The list of xpath patterns to exclude. Empty means none.",
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "default": [
                                "\\bexit\\b",
                                "\\blogout\\b",
                                "\\bdelete\\b",
                                "\\signin\\b",
                                "\\signout\\b"
                            ]
                        }
                    }
                },
                "by_link": {
                    "description_array": [
                        "The description of a crawling operations by following the links.",
                        "Please note that this 'by link' crawl mode is not the best adapted to the SPA and/or multi-frames sites."
                    ],
                    "type": "object",
                    "properties": {
                        "css_excludes": {
                            "description": "The list of CSS selectors to exclude. Empty means none. Patterns are applied against the CSS selector of the current element.",
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "default": [
                                "th > a"
                            ]
                        },
                        "enabled": {
                            "description": "Whether we want crawl by following the links. Overridable in the command-line.",
                            "type": "boolean",
                            "default": false
                        },
                        "finders": {
                            "description_array": [
                                "How to find the links in this website.",
                                "The links are extracted from the sanitized HTML, so after having applied the 'compare.ignore' exclusions."
                            ],
                            "type": "array",
                            "items": {
                                "type": "object"
                            },
                            "properties": {
                                "find": {
                                    "description": "The CSS selector to find a link.",
                                    "type": "string"
                                },
                                "member": {
                                    "description": "The member of the hash from where the link is readable.",
                                    "type": "string"
                                }
                            },
                            "default": {
                                "find": "a[href]",
                                "member": "href"
                            }
                        },
                        "honor_query": {
                            "description": "Whether to follow and honor the query fragment of the URI.",
                            "type": "boolean",
                            "default": true
                        },
                        "href_allow_patterns": {
                            "description": "The list of href member patterns to allow. Empty means all. Patterns are applied against the 'member' of the current finder expression.",
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "default": []
                        },
                        "href_deny_paterns": {
                            "description": "The list of href member patterns to exclude. Empty means none. Patterns are applied against the 'member' of the current finder expression.",
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "default": [
                                "^#",
                                "^callto:",
                                "^javascript:",
                                "^mailto:",
                                "^tel:"
                            ]
                        },
                        "text_deny_paterns": {
                            "description": "The list of text patterns to exclude. Empty means none.",
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "default": [
                            ]
                        },
                        "url_allow_patterns": {
                            "description": "The list of URLs patterns to allow. Empty means all. Patterns are applied against the full candidate URL.",
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "default": []
                        },
                        "url_deny_paterns": {
                            "description": "The list of URLs patterns to exclude. Empty means none. Patterns are applied against the full candidate URL.",
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "default": [
                                "\\bexit\\b",
                                "\\blogout\\b",
                                "\\bdelete\\b",
                                "\\signin\\b",
                                "\\signout\\b"
                            ]
                        }
                    }
                },
                "make_sitemap_csv": {
                    "description": "Whether to build a sitemap at the end.",
                    "type": "boolean",
                    "default": false
                },
                "max_visited": {
                    "description": "The maximum total count of visited pages. Zero stands for unlimited. Overridable in the command-line.",
                    "type": "integer",
                    "default": 10
                },
                "same_host": {
                    "description": "Whether to stay inside of the same domain.",
                    "type": "boolean",
                    "default": true
                }
            }
        },
        "dirs": {
            "description_array": [
                "The subdirectory parts of output directories.",
                "They are all subdirectories of the per-role log directory.",
                "We have eight potential output directories which are 'ref', 'new', 'restored' and 'diffs' crossed with 'htmls' and 'screenshots', but we only manage five as we do not try to keep htmls restored or diffs.",
                "This object says how they are organized.",
                "An empty string means that the files must not be kept."
            ],
            "type": "object",
            "properties": {
                "diffs": {
                    "description": "The differences output directories. We only manage screenshots here.",
                    "type": "object",
                    "properties": {
                        "htmls": {
                            "description": "The subdirectories of differences kept html files.",
                            "type": "string",
                            "default": ""
                        },
                        "screenshots": {
                            "description": "The subdirectories of differences screenshots.",
                            "type": "string",
                            "default": "diffs/screenshots"
                        }
                    }
                },
                "new": {
                    "description": "The new output directories.",
                    "type": "object",
                    "properties": {
                        "htmls": {
                            "description": "The subdirectories of new kept html files.",
                            "type": "string",
                            "default": "new/htmls"
                        },
                        "screenshots": {
                            "description": "The subdirectories of new kept screenshots.",
                            "type": "string",
                            "default": "new/screenshots"
                        }
                    }
                },
                "ref": {
                    "description": "The reference output directories.",
                    "type": "object",
                    "properties": {
                        "htmls": {
                            "description": "The subdirectories of reference kept html files.",
                            "type": "string",
                            "default": "ref/htmls"
                        },
                        "screenshots": {
                            "description": "The subdirectories of reference kept screenshots.",
                            "type": "string",
                            "default": "ref/screenshots"
                        }
                    }
                },
                "restored": {
                    "description": "The restored output directories.",
                    "type": "object",
                    "properties": {
                        "htmls": {
                            "description": "The subdirectories of restored kept html files.",
                            "type": "string",
                            "default": ""
                        },
                        "screenshots": {
                            "description": "The subdirectories of reference kept screenshots.",
                            "type": "string",
                            "default": "restored/screenshots"
                        }
                    }
                }
            }
        },
        "forms": {
            "description": "The list and description of forms to be handled.",
            "type": "object",
            "patternProperties": {
                "^.*$": {
                    "description": "The form CSS selector.",
                    "type": "string"
                }
            },
            "properties": {
                "submit_selector": {
                    "description": "The CSS selector of the submit element.",
                    "type": "string",
                    "default": "When not specified, the form is expected to react on 'change' event."
                }
            }
        },
        "login": {
            "description": "The login configuration.",
            "type": "object",
            "properties": {
                "excluded_cookies": {
                    "description": "The list of excluded cookies.",
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "default": [
                        "AspNetCore.Antiforgery"
                    ]
                },
                "password_selector": {
                    "description": "The CSS selector of the password field.",
                    "type": "string"
                },
                "path": {
                    "description": "The path to the login page.",
                    "type": "string"
                },
                "session_cookie_regex": {
                    "description": "A regex which identifies the name of the session cookie.",
                    "type": "string",
                    "default": "the first non-excluded cookie received."
                },
                "submit_selector": {
                    "description": "The CSS selector of the submit button.",
                    "type": "string"
                },
                "username_selector": {
                    "description": "The CSS selector of the username field.",
                    "type": "string"
                }
            }
        },
        "roles": {
            "description_array": [
                "An optional list of roles to be checked.",
                "At least one role is mandatory as soon as the sites require some sort of authentication.",
                "When no role is configured, then the verb assumes that the to-be-compared sites are public, and do not require authentication.",
                "Fondamentaly, a role is just a credentials group with a name."
            ],
            "type": "object",
            "patternProperties": {
                "^.*$": {
                    "description": "The name of the role.",
                    "type": "string"
                }
            },
            "properties": {
                "credentials": {
                    "description": "The credentials to be used when checking this role.",
                    "type": "object",
                    "properties": {
                        "password": {
                            "description": "The password.",
                            "type": "string"
                        },
                        "username": {
                            "description": "The username.",
                            "type": "string"
                        }
                    }
                },
                "enabled": {
                    "description": "Whether this role must be considered.",
                    "type": "boolean",
                    "default": true
                },
                "routes": {
                    "description": "The list of paths to be tested.",
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "default": [
                        "/"
                    ]
                },
                "signatures": {
                    "description": "The initial list of queue signature chains to be tested. When provided, routes are not considered.",
                    "type": "array",
                    "items": {
                        "type": "array",
                        "items": {
                            "type": "object"
                        },
                        "properties": {
                            "label": {
                                "description": "A description of this signatures chain.",
                                "type": "string",
                                "default": ""
                            },
                            "chain": {
                                "description": "The array of queue signatures.",
                                "type": "array",
                                "items": {
                                    "type": "string"
                                }
                            }
                        }
                    }
                }
            }
        },
        "verbosity": {
            "description": "Whether to be verbose on actions.",
            "type": "object",
            "properties": {
                "clickables": {
                    "description": "The verbosity to be applied when enqueing new clickables.",
                    "type": "object",
                    "properties": {
                        "denied": {
                            "description": "Whether to be verbose about denied clickables.",
                            "type": "boolean",
                            "default": false
                        },
                        "enqueue": {
                            "description": "Whether to be verbose when enqueing a new clickable.",
                            "type": "boolean",
                            "default": false
                        }
                    }
                },
                "daemon": {
                    "description": "The verbosity to be applied on browsers.",
                    "type": "object",
                    "properties": {
                        "received": {
                            "description": "Whether to be verbose when about the received answer from the daemon.",
                            "type": "boolean",
                            "default": false
                        },
                        "sleep": {
                            "description": "Whether to be verbose when sleeping while waiting for an answer of the daemon.",
                            "type": "boolean",
                            "default": false
                        },
                        "wait_for_page_ready": {
                            "description": "Whether to be verbose when waiting for a page be ready.",
                            "type": "boolean",
                            "default": false
                        }
                    }
                },
                "links": {
                    "description": "The verbosity to be applied when enqueing new links.",
                    "type": "object",
                    "properties": {
                        "denied": {
                            "description": "Whether to be verbose about denied links.",
                            "type": "boolean",
                            "default": false
                        },
                        "enqueue": {
                            "description": "Whether to be verbose when enqueing a new link.",
                            "type": "boolean",
                            "default": false
                        }
                    }
                }
            }
        }
    }
}
